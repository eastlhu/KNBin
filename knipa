# cd /Users/devzkn/code/cocoapodDemo/podDemo/KNBaseWebViewControllerDemo
#!/bin/sh
# é€šè¿‡ æ‰“ipaåŒ…
# ===============================é¡¹ç›®è‡ªå®šä¹‰éƒ¨åˆ†============================= #
# .xcworkspaceé¡¹ç›®,èµ‹å€¼true;ç”¨Xcodeé»˜è®¤åˆ›å»ºçš„.xcodeproj,èµ‹å€¼false
is_workspace="true"
# æŒ‡å®šé¡¹ç›®çš„schemeåç§°ï¼Œæœ€å¥½ä¿®æ”¹æˆå‚æ•°ä¼ é€’è¿›æ¥
# scheme_name="you_scheme_name"
# å·¥ç¨‹ä¸­Targetå¯¹åº”çš„é…ç½®plistæ–‡ä»¶åç§°, Xcodeé»˜è®¤çš„é…ç½®æ–‡ä»¶ä¸ºInfo.plist
info_plist_name="Info"
# æ‰“åŒ…ç¼–è¯‘çš„æ–¹å¼ : Release,Debug Debug
build_configuration="Debug"

# ===============================è‡ªåŠ¨æ‰“åŒ…éƒ¨åˆ†()============================= #

# ExportOptionsPlistPath
ExportOptionsPlistPath="/Users/devzkn/iOSAutoArchiveScript/developmentExportOptionsPlist.plist"
# mkdir -p ~/AutoArchive/$scheme_name-IPA/

# è·å–é¡¹ç›®åç§°
project_name=`find . -name *.xcodeproj | awk -F "[/.]" '{print $(NF-1)}'`
# è·å–ç‰ˆæœ¬å·,å†…éƒ¨ç‰ˆæœ¬å·,bundleID
echo "project_name:"-"$project_name"
InfoPlistPath="$project_name/$info_plist_name.plist"
bundle_version=`/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" $InfoPlistPath`
bundle_build_version=`/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" $InfoPlistPath`
bundle_identifier=`/usr/libexec/PlistBuddy -c "Print CFBundleVersion" $InfoPlistPath`


scheme_name="$project_name"
echo "scheme_name:"-"$scheme_name"
# æŒ‡å®šè¾“å‡ºipaè·¯å¾„
export_path=~/AutoArchive/$scheme_name-IPA
export_ipa_path="$export_path"

# æŒ‡å®šè¾“å‡ºå½’æ¡£æ–‡ä»¶åœ°å€
export_archive_path="$export_path/$scheme_name.xcarchive"

 # åˆ é™¤æ—§.xcarchiveæ–‡ä»¶
rm -rf export_archive_path

# æŒ‡å®šè¾“å‡ºipaåç§° : scheme_name + bundle_version
ipa_name="$scheme_name-v$bundle_version"


echo "================è¯·é€‰æ‹©æ‰“åŒ…æ–¹å¼(è¾“å…¥åºå·,æŒ‰å›è½¦å³å¯)================"
echo "                1 AdHoc       å†…æµ‹        "
echo "                2 AppStore    ä¸Šæ¶        "
echo "                3 Enterprise  ä¼ä¸š        "
echo "                development å¼€å‘--é»˜è®¤,ç›´æ¥æŒ‰å›è½¦        "
echo "                4 è¿›è¡Œipa åŒ…çš„å¯¼å‡º        "
echo "                q Exit        é€€å‡º        "
echo "================è¯·é€‰æ‹©æ‰“åŒ…æ–¹å¼(è¾“å…¥åºå·,æŒ‰å›è½¦å³å¯)================"


# è¯»å–ç”¨æˆ·è¾“å…¥å¹¶å­˜åˆ°å˜é‡é‡Œ
read parameter
sleep 0.5
method="$parameter"


# åˆ¤è¯»ç”¨æˆ·æ˜¯å¦æœ‰è¾“å…¥
if [ -n "$method" ]
then
    if [ "$method" = "1" ] ; then
    ExportOptionsPlistPath="./iOSAutoArchiveScript/AdHocExportOptionsPlist.plist"
    elif [ "$method" = "2" ] ; then
    ExportOptionsPlistPath="./iOSAutoArchiveScript/AppStoreExportOptionsPlist.plist"
    elif [ "$method" = "3" ] ; then
    ExportOptionsPlistPath="./iOSAutoArchiveScript/EnterpriseExportOptionsPlist.plist"

    elif [ "$method" = "4" ] ; then
    method=4;

    elif [ "$method" = "q" ] ; then

    echo "é€€å‡ºï¼"

    exit 1

    else

    echo "è¾“å…¥çš„å‚æ•°æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©!!!"
    exit 1
    fi
fi


echo "**************************å¼€å§‹ç¼–è¯‘ä»£ç ...*********************************"
# æŒ‡å®šè¾“å‡ºæ–‡ä»¶ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º
function knmkdir() {
	if [ -d "$export_path" ] ; then
		echo $export_path
	else
		mkdir -pv $export_path
	fi

}

knmkdir


function knxcodebuild() {

# ç¼–è¯‘å‰æ¸…ç†å·¥ç¨‹
xcodebuild clean -workspace ${project_name}.xcworkspace \
                 -scheme ${scheme_name} \
                 -configuration ${build_configuration}

xcodebuild archive -workspace ${project_name}.xcworkspace \
                   -scheme ${scheme_name} \
                   -configuration ${build_configuration} \
                   -archivePath ${export_archive_path}

}

function knxcodebuildprojectorworkspace() {

  # åˆ¤æ–­ç¼–è¯‘çš„é¡¹ç›®ç±»å‹æ˜¯workspaceè¿˜æ˜¯project
  if $is_workspace ; then

    knxcodebuild


  else
# ç¼–è¯‘å‰æ¸…ç†å·¥ç¨‹
xcodebuild clean -project ${project_name}.xcodeproj \
-scheme ${scheme_name} \
-configuration ${build_configuration}

xcodebuild archive -project ${project_name}.xcodeproj \
-scheme ${scheme_name} \
-configuration ${build_configuration} \
-archivePath ${export_archive_path}
fi



#  æ£€æŸ¥æ˜¯å¦æ„å»ºæˆåŠŸ
#  xcarchive å®é™…æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶æ‰€ä»¥ä½¿ç”¨ -d åˆ¤æ–­
if [ -d "$export_archive_path" ] ; then
  echo " âœ…  âœ…  âœ…  âœ…  âœ…  âœ…  ç¼–è¯‘æˆåŠŸ  âœ…  âœ…  âœ…  âœ…  âœ…  âœ…  "
else
  echo " âŒ  âŒ  âŒ  âŒ  âŒ  âŒ  ç¼–è¯‘å¤±è´¥  âŒ  âŒ  âŒ  âŒ  âŒ  âŒ  "
  exit 1
fi


}






function knxcodeipa() {


  echo "**************************å¼€å§‹å¯¼å‡ºipaæ–‡ä»¶....*********************************"
# Xcode9éœ€è¦åŠ ä¸Š -allowProvisioningUpdates 

xcodebuild  -exportArchive \
-archivePath ${export_archive_path} \
-exportPath ${export_ipa_path} \
-exportOptionsPlist ${ExportOptionsPlistPath} \
-allowProvisioningUpdates



# ä¿®æ”¹ipaæ–‡ä»¶åç§°
mv $export_ipa_path/$scheme_name.ipa $export_ipa_path/$ipa_name.ipa



# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ -f "$export_ipa_path/$ipa_name.ipa" ] ; then
  echo "ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ${ipa_name} æ‰“åŒ…æˆåŠŸ! ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  ğŸ‰  "
  open $export_path
else
  echo "âŒ  âŒ  âŒ  âŒ  âŒ  âŒ  ${ipa_name} æ‰“åŒ…å¤±è´¥! âŒ  âŒ  âŒ  âŒ  âŒ  âŒ  "
  exit 1
fi


# è¾“å‡ºæ‰“åŒ…æ€»ç”¨æ—¶
echo "æ‰“åŒ…æ€»ç”¨æ—¶: ${SECONDS}s ~~~~~~~~~~~~~~~~"

}


if [ "$method" = "4" ] ; then

knxcodeipa
else

  knxcodebuildprojectorworkspace
  knxcodeipa
fi








